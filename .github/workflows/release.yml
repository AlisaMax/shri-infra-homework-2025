name: Release

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test

      - name: Install Yandex CLI and configure docker auth
        run: |
          curl https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH="$PATH:$HOME/yandex-cloud/bin"
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY_JSON }}' > key.json
          yc --version
          yc config set service-account-key key.json
          yc config set cloud-id b1g5bv1glb6q0iu7ujil
          yc config set folder-id b1gmgijkm3ugaq00n1le
          yc container registry configure-docker
          docker-credential-yc version
          cat ~/.docker/config.json
          rm key.json

      - name: Build Docker image
        run: |
          docker build -t cr.yandex/crp3t6gvtieggu7lip3q/app:${{ github.run_number }} .
          docker tag cr.yandex/crp3t6gvtieggu7lip3q/app:${{ github.run_number }} cr.yandex/crp3t6gvtieggu7lip3q/app:${{ github.run_number }}_latest

      - name: Push Docker image
        run: |
          docker push cr.yandex/crp3t6gvtieggu7lip3q/app:${{ github.run_number }}
          docker push cr.yandex/crp3t6gvtieggu7lip3q/app:${{ github.run_number }}_latest

      - name: Create release tag
        run: |
          git tag ${{ github.run_number }}
          git push origin ${{ github.run_number }}

      - name: Create release issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Release ${{ github.run_number }}`,
              body: `Release created\n\nVersion: ${{ github.run_number }}\nDate: ${new Date().toISOString()}`,
            })
